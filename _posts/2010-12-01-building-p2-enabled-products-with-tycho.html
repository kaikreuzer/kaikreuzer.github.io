---
layout: post
title: Building p2-enabled products with Tycho
date: '2010-12-01T19:21:00.000+01:00'
author: Kai Kreuzer
tags:
- eclipse
- openhab
- tycho
modified_time: '2010-12-01T19:21:39.568+01:00'
blogger_id: tag:blogger.com,1999:blog-5335810078566775677.post-2872964441148961003
blogger_orig_url: http://kaikreuzer.blogspot.com/2010/12/building-p2-enabled-products-with-tycho.html
---

Working on the build and the packaging of&nbsp;<a href="http://www.openHAB.org/">openHAB</a>, I had to undergo quite some efforts to get it done with Maven3/Tycho.<br /><br />My special challenge was to package a product which is p2-enabled <b>and</b>&nbsp;includes root files. If you just want to do the one or the other, it works quite straight forward: You can use the "eclipse-application" Tycho packaging type to build Eclipse RCP products, which will also nicely include any root files that you have defined on your features.<br /><br />Since version 0.10.0, Tycho also supports building p2-enabled products (<a href="https://issues.sonatype.org/browse/TYCHO-188">TYCHO-188</a>), but you will have to use the "eclipse-repository" packaging type to do so. Unfortunately, root file inclusion does not work with this packaging type (due to very complex reasons, see <a href="https://issues.sonatype.org/browse/TYCHO-513">TYCHO-513</a> and <a href="https://issues.sonatype.org/browse/TYCHO-465">TYCHO-465</a>).<br /><br />So what is the workaround to have both at the same time? I have chosen a combination of the "eclipse-repository" packaging and the "classic" Maven assembly plugin to do this job.<br /><br />The "eclipse-repository" packaging is used in a <a href="https://code.google.com/p/openhab/source/browse/products/org.openhab.runtime.product/">Maven project that contains the RCP product definition</a>. Using the "materialize-products" and "archive-products execution, makes sure that the p2 director is used to install and package a product from the repository (for all platforms that are listed in the configuration of the target-platform-configuration Maven plugin). Note that choosing Mac as a platform does not seem to be an option right now, at least I could not get it working...<br /><br />If you now run a <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-size: x-small;">"mvn clean install"</span></span> on this project, you will find the resulting zip files in the target folder. But how to add additional files (such as readmes, licenses, start scripts, additional libraries and folders, etc.) to it to make it your final distribution? That's where the Maven assembly plugin comes into play:<br /><br />You need to create a <a href="https://code.google.com/p/openhab/source/browse/#hg/distribution%3Fstate%3Dclosed">Maven project that contains the files you want to add</a>. The assembly plugin allows the inclusion of project dependencies in the assembly, so we need to define a dependency on our product project in our pom.xml. The problem here is that if you do this as usual, you will end up with the packaged p2 repository to be included in your assembly as this is the primary artifact built by the "eclipse-repository" packaging. Luckily, the product zips are attached as additional artifacts to the build result, so we can define a dependency like:<br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>&lt;dependency&gt;<br />  &lt;groupId&gt;com.acme&lt;/groupId&gt;<br />  &lt;artifactId&gt;com.acme.rcp.product&lt;/artifactId&gt;<br />  &lt;version&gt;${project.version}&lt;/version&gt;<br />  &lt;type&gt;zip&lt;/type&gt;<br />  &lt;classifier&gt;win32.win32.x86&lt;/classifier&gt;<br />&lt;/dependency&gt;<br /><br /></code></pre>In the&nbsp;<a href="https://code.google.com/p/openhab/source/browse/distribution/src/assemble/designer-win.xml">assembly descriptor</a>, you then need to say that you want to unpack this dependency into your assembly. As Tycho often packages a bit to much into the zips, you can also take this opportunity to remove a few contents that you do not want in your final distribution:<br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code><br />&lt;dependencySets&gt;<br />  &lt;dependencySet&gt;<br />    &lt;useStrictFiltering&gt;true&lt;/useStrictFiltering&gt;<br />    &lt;useProjectArtifact&gt;false&lt;/useProjectArtifact&gt;<br />    &lt;useTransitiveDependencies&gt;false&lt;/useTransitiveDependencies&gt;<br />    &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;<br />    &lt;unpack&gt;true&lt;/unpack&gt;<br />    &lt;unpackOptions&gt;<br />      &lt;excludes&gt;<br />        &lt;exclude&gt;**/org.eclipse.platform.doc*.jar&lt;/exclude&gt;<br />        &lt;exclude&gt;**/org.eclipse.jdt.doc*.jar&lt;/exclude&gt;<br />      &lt;/excludes&gt;<br />    &lt;/unpackOptions&gt;      <br />    &lt;includes&gt;<br />      &lt;include&gt;*:org.openhab.designer.product:*:win32.win32.x86&lt;/include&gt;<br />    &lt;/includes&gt;<br />  &lt;/dependencySet&gt;<br />&lt;/dependencySets&gt;<br /></code></pre>Note the reference to include (only) the dependency to the zip for the Windows platform; this is necessary as you might have many dependencies for different platforms defined in your assembly pom.xml. This include tag makes sure that this assembly descriptor picks up the right dependency (you can have other assembly descriptors for other platforms in the same assembly project).<br /><br />This solution might not be the most elegant, especially if you are building packages for many different platforms (you need a separate assembly descriptor for each). But it works for me and I thought it could be helpful to others as well. If anybody knows a smarter solution or has a suggestion how to improve mine, I'll be more than happy to listen :-)