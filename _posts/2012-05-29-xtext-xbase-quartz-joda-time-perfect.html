---
layout: post
title: Xtext + Xbase + Quartz + Joda Time = Perfect Rule Engine
date: '2012-05-29T08:19:00.000+02:00'
author: Kai Kreuzer
tags:
- eclipse
- openhab
- xbase
- xtext
modified_time: '2012-05-29T08:19:10.180+02:00'
blogger_id: tag:blogger.com,1999:blog-5335810078566775677.post-4729201051608363360
blogger_orig_url: http://kaikreuzer.blogspot.com/2012/05/xtext-xbase-quartz-joda-time-perfect.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Half a year ago I <a href="http://kaikreuzer.blogspot.com/2011/09/using-xbase-for-home-automation-rules.html">sketched my ideas</a> for a new rule engine for the <a href="http://www.openhab.org/">open Home Automation Bus (openHAB)</a>. I had presented an initial version at&nbsp;<a href="http://www.eclipsecon.org/europe2011/sessions/eclipsehome-%E2%80%93-home-automation-practice">EclipseCon Europe 2011</a> and it is by now used by most openHAB users - I think Xtext/Xbase has been a great choice for this implementation and I would like to share some information of how this solution looks like.<br /><h4 style="text-align: left;">     <span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;">  1. Xtext for the Rule Skeleton</span></h4><div><a href="http://www.eclipse.org/Xtext/">Xtext</a> allows us to freely define the syntax for our rule definitions. An openHAB rule consists out of two sections, the trigger definition and the script to execute.&nbsp;openHAB specific concepts such as items and events can be nicely integrated into the grammar.&nbsp;An example rule would look like this:</div><pre style="background-color: white; background-position: initial initial; background-repeat: initial initial;"><span style="color: black;">rule <span style="color: maroon;">"</span><span style="color: #0000e6;">Turn light on</span><span style="color: maroon;">"</span><br />    when<br />        Item </span><span style="color: #38761d;">Door</span><span style="color: black;"> changed to </span><span style="color: #990000;">OPEN</span><br />    then<br />        <span style="color: #38761d;">Light</span>.postUpdate<span style="color: #808030;">(</span><span style="color: #990000;">ON</span><span style="color: #808030;">)</span><br />end</pre><h4 style="text-align: left;">          <span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;">  2. Xbase for the Execution Code Block</span></h4><div>The "then" part of a rule could simply be designed to be a sequence of pre-defined commands to execute. Reality shows that most users quickly require much more than this - they ask for complex calculation possibilities and execution flow constructs. <a href="http://www.eclipse.org/Xtext/#xbase">Xbase</a> comes in very handy as a powerful and customizable scripting language that is an integral part of Xtext. The functional programming oriented constructs make it easy to express logic in a few lines, where "classical" object-oriented languages would require much more procedural code:<br /><pre style="background-color: white; background-position: initial initial; background-repeat: initial initial;"><span style="color: black;">rule <span style="color: maroon;">"</span><span style="color: #0000e6;">Initialize light states with random values</span><span style="color: maroon;">"</span><br />    when<br />        System started<br />    then<br />        </span><span style="color: #38761d;">Lights</span><span style="color: purple;">?</span><span style="color: #808030;">.</span>members<span style="color: #808030;">.</span>forEach<span style="color: #808030;">(</span>light<span style="color: #808030;">|</span><br />            light<span style="color: #808030;">.</span>postUpdate<span style="color: #808030;">(</span><span style="color: maroon;">if</span><span style="color: #808030;">(</span><span style="color: #797997;">Math</span><span style="color: purple;">:</span><span style="color: purple;">:</span><span style="color: maroon;">random</span> <span style="color: #808030;">&gt;</span> <span style="color: green;">0.7</span><span style="color: #808030;">)</span> <span style="color: #990000;">ON</span> <span style="color: maroon;">else</span> <span style="color: #990000;">OFF</span><span style="color: #808030;">)</span><br />        <span style="color: #808030;">)</span><br />end</pre><h4 style="text-align: left;">          <span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;">3. Quartz as a Scheduler</span></h4></div><div>Many home automation use cases require to execute actions regularly at certain times. openHAB makes use of the <a href="http://quartz-scheduler.org/">Quartz library</a>, which is helpful for scheduling jobs for execution in Java. As the <a href="http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger">cron syntax</a> is very expressive, openHAB allows to directly use cron strings for time trigger definitions. Alternatively - for very common values - some pre-defined strings such as "noon" and "midnight" can be used:</div><div><pre style="background: #ffffff; color: black;">rule <span style="color: maroon;">"</span><span style="color: #0000e6;">Time trigger</span><span style="color: maroon;">"</span><br />    when <br />        Time is midnight or<br />        Time cron <span style="color: maroon;">"</span><span style="color: #0000e6;">0 15 * * * ?</span><span style="color: maroon;">"</span><br />    then<br />        callScript<span style="color: #808030;">(</span><span style="color: maroon;">"</span><span style="color: #0000e6;">doSomething</span><span style="color: maroon;">"</span><span style="color: #808030;">)</span><br />end</pre><h4 style="text-align: left;">         <span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;">4. Joda Time for Date and Time Calculations</span></h4>In many cases you might want to refer to a relative point in time, e.g. "one hour ago", or "on the 1st of this month".&nbsp;<a href="http://joda-time.sourceforge.net/">Joda Time</a> has a wonderful simple and yet very powerful fluent API to do exactly such kind of things. In openHAB, you can use this to access historic information as well as for scheduling code for future execution - in the latter case, the code will be run as a scheduled Quartz job.<br /><br /><pre style="background: #ffffff; color: black;">rule <span style="color: maroon;">"</span><span style="color: #0000e6;">Automatically turn off Staircase Lights</span><span style="color: maroon;">"</span><br />    when<br />        Item Light_Staircase received command ON<br />    then<br />        createTimer<span style="color: #808030;">(</span>now<span style="color: #808030;">.</span>plusMinutes<span style="color: #808030;">(</span><span style="color: #008c00;">10</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span> <span style="color: #808030;">[</span><span style="color: #808030;">|</span><br />            Light_Staircase<span style="color: #808030;">.</span>sendCommand<span style="color: #808030;">(</span>OFF<span style="color: #808030;">)</span><br />        <span style="color: #808030;">]</span><br />end<br /></pre><pre style="background-color: white; text-align: left;">rule <span style="color: maroon;">"</span><span style="color: blue;">Turn on irrigation system after two days without rain</span><span style="color: maroon;">"</span><br />    when<br />        Time is midnight<br />    then<br />        <span style="color: maroon; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #38761d;">Rain</span><span style="color: #808030;">==</span>OFF <span style="color: #808030;">&amp;&amp;</span> <span style="color: #808030;">!</span><span style="color: #38761d;">Rain</span><span style="color: #808030;">.</span>changedSince<span style="color: #808030;">(</span>now<span style="color: #808030;">.</span>minusDays<span style="color: #808030;">(</span><span style="color: #008c00;">2</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span> <span style="color: purple;">{</span><br />            <span style="color: #38761d;">Irrigation</span><span style="color: #808030;">.</span>sendCommand<span style="color: #808030;">(</span><span style="color: #990000;">ON</span><span style="color: #808030;">)</span><br />        <span style="color: purple;">}</span><br />end<br /></pre><h4 style="text-align: left;">  <span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;">Summary</span></h4><div>For most openHAB users this new rule engine is a better choice than the previous Drools-based engine. Although it does not offer as many rule features as Drools does (e.g. conditional triggers, rule grouping, dynamic deactivation, execution order inference etc.), it proves to be strong on other important points:</div><ul style="text-align: left;"><li>It has a syntax that is easy to read and write and which integrates well with openHAB concepts such as items and events.</li><li>It has full IDE support in the <a href="http://code.google.com/p/openhab/wiki/architecture#openHAB_Designer">openHAB Designer </a>such as syntax validation and highlighting, content assist etc.</li><li>It is much leaner at runtime as the code is interpreted and does not need to be compiled to Java byte code (which in turn requires a Java compiler to be part of the runtime)</li><li>It has very limited memory requirements at runtime as the code is very compact and it does not require any dedicated rule engine context where item state information would be duplicated.</li></ul><div>For these reasons, the new rule engine has been made the default, which is shipped with the <a href="http://code.google.com/p/openhab/downloads/list">core openHAB runtime distribution</a>. For users who require the full power of Drools, a separate Drools-package is still available as an optional download.</div></div></div>